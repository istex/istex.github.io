
'use strict';;(function($,window,document,undefined){var pluginName="istexSearch";var defaults=istexConfigDefault;function Plugin(element,options){this.elt=element;this.settings=$.extend({},defaults,istexConfig,options);this._defaults=defaults;this._name=pluginName;this.init();}
Plugin.prototype.init=function(){var self=this;$(document).bind(self.settings.connectedEventName,function(event,istexAuth){self.istexApiRequester=istexAuth.istexApiRequester;self.loadInputForm();});$(document).bind(self.settings.gotoPageEventName,function(event,pageIdx){self.execQuery({},pageIdx);});};Plugin.prototype.loadInputForm=function(){var self=this;$(self.elt).empty();var searchFormHtml=$('<form class="istex-search-form">'+'<div class="istex-search-bar-wrapper">'+'<input class="istex-search-submit" type="submit" value="Rechercher" />'+'<span>'+'<input class="istex-search-input" type="search" value="" placeholder="Votre requÃªte ici ..." />'+'</span>'+'</div>'+'<p class="istex-search-error"></p>'+'<div class="istex-search-loading" title="Recherche en cours"></div>'+'</form>').hide();$(self.elt).append(searchFormHtml);searchFormHtml.fadeIn();$(self.elt).find('.istex-search-input').val(self.settings.query);$(self.elt).find('.istex-search-form').submit(function(){var query=$(self.elt).find('input.istex-search-input').val().trim();query=query?query:'*';$.event.trigger(self.settings.newSearchEventName,[self]);self.execQuery({q:query});return false;});$(self.elt).find('.istex-search-submit').css('font-size',$(self.elt).find('.istex-search-input').css('font-size'));$(self.elt).find('.istex-search-submit').css('padding',$(self.elt).find('.istex-search-input').css('padding'));if(self.settings.query){$(self.elt).find('.istex-search-form').trigger('submit');}};Plugin.prototype.execQuery=function(queryOptions,pageIdx){var self=this;pageIdx=pageIdx||1;queryOptions=queryOptions||{};if(queryOptions.q){self.query=queryOptions.q;}else{queryOptions.q=self.query;}
self.queryStartTime=new Date();$.event.trigger(self.settings.waitingForResultsEventName,[self]);$(self.elt).find('.istex-search-loading').show();$(self.elt).find('.istex-search-error').hide();var queryString={q:queryOptions.q,output:'*',size:self.settings.pageSize,from:((pageIdx-1)*self.settings.pageSize)};queryString=$.extend(queryOptions,queryString);if(self.settings.showQuerySpeed){queryString.stats=1;}
if(self.settings.facetsToLoad&&self.settings.facetsToLoad.length>0){queryString.facet=self.settings.facetsToLoad.join(',');}
self.istexApiRequester({url:self.settings.istexApi+'/document/',data:queryString,success:function(items){$(self.elt).find('.istex-search-error').hide();$(self.elt).find('.istex-search-loading').fadeOut();$.event.trigger(self.settings.resultsEventName,[items,self]);},error:function(opt,err){$(self.elt).find('.istex-search-error').html('<a href="https://api.istex.fr/corpus/">API Istex</a> non joignable.');$(self.elt).find('.istex-search-error').fadeIn();$(self.elt).find('.istex-search-loading').fadeOut();$.event.trigger(self.settings.resultsEventName,[null,self]);}});};$.fn[pluginName]=function(options){this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new Plugin(this,options));}});return this;};})(jQuery,window,document);