
'use strict';;(function($,window,document,undefined){var pluginName="istexAuth";var defaults=istexConfigDefault;function Plugin(element,options){this.elt=element;this.settings=$.extend({},defaults,istexConfig,options);this._defaults=defaults;this._name=pluginName;this.init();}
Plugin.prototype.init=function(){var self=this;self.getAuthMode(function(err,needAuth,authMode){if(needAuth=='none'){self.setupGenericRequester(authMode);self.removeConnectBtn();$.event.trigger(self.settings.connectedEventName,[self]);}else if(needAuth=='redirect'){self.authWithRedirect(function(err){if(!err){self.setupGenericRequester(authMode);self.removeConnectBtn();$.event.trigger(self.settings.connectedEventName,[self]);}});}else if(needAuth=='http'){self.authWithHTTP(function(err,options){if(!err){self.setupGenericRequester(authMode,options);self.removeConnectBtn();$.event.trigger(self.settings.connectedEventName,[self]);}});}});};Plugin.prototype.getAuthMode=function(cb){var self=this;$.ajax({url:self.settings.istexApi+'/corpus/',success:function(){return cb(null,'none','ajax');},error:function(opt,err){if(opt.status==0||opt.status==302){$.jsonp({url:self.settings.istexApi+'/corpus/',callbackParameter:"callback",success:function(){cb(null,'none','jsonp');},error:function(){cb(null,'redirect','jsonp');}});}else{return cb(null,'http','ajax');}}});};Plugin.prototype.authWithRedirect=function(cb){var self=this;self.insertConnectBtnIfNotExists(function(){window.open(self.settings.istexApi+'/ezproxy-auth-and-close.html');$(window).focus(function(){self.getAuthMode(function(err,needAuth,authMode){if(needAuth=='none'){cb(null);}else{cb(new Error("Unable to authenticate"));}});});});};Plugin.prototype.insertConnectBtnIfNotExists=function(cb){var self=this;if($(self.elt).find('.istex-ezproxy-auth-btn').length>0)return;$(self.elt).append('<button class="istex-ezproxy-auth-btn">Se connecter<div></div></button>');$(self.elt).find('.istex-ezproxy-auth-btn').click(cb);};Plugin.prototype.removeConnectBtn=function(cb){var self=this;$(self.elt).find('.istex-ezproxy-auth-btn').remove();};Plugin.prototype.authWithHTTP=function(cb){var self=this;self.insertConnectBtnIfNotExists(function(){if($(self.elt).find('.istex-auth-popup').length>0)return;$(self.elt).append('<form class="istex-auth-popup">'+'<div class="istex-auth-popup-wrapper">'+'<input class="istex-auth-popup-login" type="text" value="" placeholder="Votre login ..." />'+'<input class="istex-auth-popup-password" type="password" value="" placeholder="Votre mot de passe ..." />'+'<input class="istex-auth-popup-cancel" type="submit" value="Annuler" />'+'<input class="istex-auth-popup-submit" type="submit" value="Se connecter" />'+'</div>'+'<p class="istex-auth-popup-error"></p>'+'</form>');$(self.elt).find('.istex-auth-popup').submit(function(){var clicked=$(self.elt).find(".istex-auth-popup input[type=submit]:focus").attr('class');if(clicked=='istex-auth-popup-submit'){var httpOptions={username:$(self.elt).find('istex-auth-popup-login').val(),password:$(self.elt).find('istex-auth-popup-password').val(),};$.ajax({url:self.settings.istexApi+'/corpus/',username:httpOptions.username,password:httpOptions.password,success:function(){$(self.elt).find('.istex-auth-popup').remove();return cb(null,httpOptions);},error:function(opt,err){$(self.elt).find('.istex-auth-popup-error').text("Le nom d'utilisateur ou le mot de passe saisi est incorrect.")}});}else if(clicked=='istex-auth-popup-cancel'){$(self.elt).find('.istex-auth-popup').remove();cb(new Error('HTTP auth canceled'));}
return false;});});};Plugin.prototype.setupGenericRequester=function(authMode,options){var self=this;if(authMode=='jsonp'){self.istexApiRequester=function(options){var reqOpt=$.extend({callbackParameter:"callback"},options);return $.jsonp(reqOpt);};}else{self.istexApiRequester=function(options){var reqOpt=$.extend({headers:{}},options);return $.ajax(reqOpt);};}};$.fn[pluginName]=function(options){this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new Plugin(this,options));}});return this;};})(jQuery,window,document);